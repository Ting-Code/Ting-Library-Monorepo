# ğŸ“‹NodejsåŸºç¡€

## Nodeç®€ä»‹

Node.jsæ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„ã€éé˜»å¡å¼çš„ã€å•çº¿ç¨‹ã€å¼‚æ­¥çš„I/Oçš„JavaScriptè¿è¡Œç¯å¢ƒã€‚

- å•çº¿ç¨‹çš„æœ€å¤§å¥½å¤„æ˜¯
  - ä¸ç”¨åƒå¤šçº¿ç¨‹ç¼–ç¨‹é‚£æ ·å¤„å¤„è€ƒè™‘çŠ¶æ€åŒæ­¥é—®é¢˜
  - æ²¡æœ‰æ­»é”çš„å­˜åœ¨
  - ä¹Ÿæ²¡æœ‰ä¸Šä¸‹çº¿ç¨‹äº¤æ¢å¸¦æ¥çš„æ€§èƒ½å¼€é”€
- å•çº¿ç¨‹ç¼ºç‚¹
  - æ— æ³•åˆ©ç”¨å¤šæ ¸CPU
  - é”™è¯¯ä¼šå¼•èµ·æ•´ä¸ªåº”ç”¨é€€å‡ºï¼Œåº”ç”¨å¥å£®æ€§é‡å¤§è€ƒéªŒ
  - å¤§é‡è®¡ç®—å ç”¨CPUå¯¼è‡´æ— æ³•è°ƒç”¨å¼‚æ­¥I/O

### Nodeåº”ç”¨

- I/Oå¯†é›†å‹
- ä¸æ“…é•¿CPUå¯†é›†å‹
  - ä½†V8æ‰§è¡Œæ•ˆç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„
  - ä¸»è¦åŸå› å•çº¿ç¨‹ï¼Œä¸é€‚åˆé•¿æ—¶é—´è¿ç®—ï¼Œå¯ä»¥åˆ†è§£ä¸ºå°ä»»åŠ¡å……åˆ†åˆ©ç”¨CPU
  - é€šè¿‡å­çº¿ç¨‹æ–¹å¼å°†è®¡ç®—ä¸I/Oåˆ†ç¦»
- åˆ†å¸ƒå¼åº”ç”¨ï¼Œä¸­é—´å±‚åº”ç”¨

### å®é™…åº”ç”¨åœºæ™¯

- socket.ioå®ç°å®æ—¶é€šçŸ¥åŠŸèƒ½
- åˆ†å¸ƒå¼ä¸­é—´å±‚
- äº‘è®¡ç®—å¹³å°æ‰˜ç®¡æœåŠ¡
- æ¸¸æˆå¼€å‘é¢†åŸŸï¼šç½‘æ˜“pomeloå®æ—¶æ¡†æ¶
- å‰ç«¯å·¥å…·

## Node.jsçš„æŠ€æœ¯æ¶æ„

- V8å¼•æ“
- libuv
- C/C++å®ç°çš„c-aresã€http-parserã€OpemSSLã€zlibç­‰åº“

|  |  | Node.js API (httpæ¨¡å—ã€fsæ¨¡å—ã€streamæ¨¡å—)ç­‰ |  |  |
| --- | --- | :-: | --- | --- |
|  | Node.js bindings (è®©jsä¸C/C++é€šä¿¡) |  | C/C++æ’ä»¶ (è‡ªå®šä¹‰å…¶ä»–èƒ½åŠ›) |  |
| jså¼•æ“V8 | è·¨å¹³å°çš„å¼‚æ­¥I/Oé€šä¿¡èƒ½åŠ›libuv | DNSè§£æc-ares | åŠ å¯†è§£å¯†OpenSSL | å…¶ä»–zlibç­‰åº“ |

### bindings

èƒŒæ™¯ï¼šC/C++å®ç°ä¸€ä¸ªhttp_parseråº“å¾ˆé«˜æ•ˆï¼Œä½†æ˜¯åªä¼šå†™JSã€‚æ‰€ä»¥bindingså½“JSä¸C/C++çš„æ¡¥æ¢ã€‚

- Node.jsç”¨C++å¯¹http_parserè¿›è¡Œå°è£…ï¼Œå°è£…æ–‡ä»¶å«http_parser_bindings.cpp
- Node.jsæä¾›ç¼–è¯‘å·¥å…·ç¼–è¯‘ä¸º.nodeæ–‡ä»¶
- è¿™æ ·å°±å¯ä»¥JSè°ƒç”¨C++åº“ï¼ŒNode.jsæä¾›å¾ˆå¤šbindingï¼Œæ‰€ä»¥+sã€‚å°±æ˜¯bindings

JSè°ƒç”¨C++

å®˜æ–¹ç¤ºä¾‹ï¼š[http://nodejs.cn/api/addons.html#addons_function_arguments](http://nodejs.cn/api/addons.html#addons_function_arguments)

C++è°ƒç”¨JSå›è°ƒ

å®˜æ–¹ç¤ºä¾‹ï¼š[http://nodejs.cn/api/addons.html#addons_callbacks](http://nodejs.cn/api/addons.html#addons_callbacks)

### V8å¼•æ“

åŠŸèƒ½ï¼š

- å°†JSæºä»£ç å˜æˆæœ¬åœ°ä»£ç å¹¶æ‰§è¡Œ
- ç»´æŠ¤è°ƒç”¨æ ˆï¼Œç¡®ä¿JSå‡½æ•°çš„æ‰§è¡Œé¡ºåº
- å†…å­˜ç®¡ç†ï¼Œä¸ºæ‰‹æ¸¸å¯¹è±¡åˆ†é…å†…å­˜
- åƒåœ¾å›æ”¶ï¼Œé‡å¤åˆ©ç”¨æ— ç”¨çš„å†…å­˜
- å®ç°JSçš„æ ‡å‡†åº“

æ³¨æ„ç‚¹ï¼š

- V8ä¸æä¾›DOM API
- V8æ‰§è¡ŒJSæ˜¯å•çº¿ç¨‹
- å¯ä»¥å¼€å¯ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¸åŒJS
- V8æ˜¯å¤šçº¿ç¨‹çš„ï¼šå¦‚åƒåœ¾å›æ”¶ä¸ºå•ç‹¬çº¿ç¨‹
- è‡ªå¸¦event loop ä½†Node.jsåŸºäºlibuvè‡ªå·±åšäº†ä¸€ä¸ª

### libuvè·¨å¹³å°

èƒŒæ™¯ï¼š

- FreeBSDç³»ç»Ÿæœ‰kqueueã€Linuxç³»ç»Ÿä¸Šæœ‰epollã€Windowsç³»ç»Ÿæœ‰IOCPçš„å¼‚æ­¥I/Oåº“
- Ryanï¼ˆä½œè€…ï¼‰ä¸ºäº†å®ç°è·¨å¹³å°çš„å¼‚æ­¥I/Oåº“ï¼Œå¼€å§‹å†™libuv
- libuvä¼šæ ¹æ®ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ

åŠŸèƒ½ï¼š

- ç”¨äºTCP/UDP/DNSæ–‡ä»¶çš„å¼‚æ­¥æ“ä½œ
- Nodeçš„ç¬¬ä¸‰æ–¹C++æ¨¡å—å¯ä»¥å€ŸåŠ©libuvå®ç°è·¨å¹³å°

### Event Loop

ä»€ä¹ˆæ˜¯Event

- å†…éƒ¨çš„è®¡ç®—å™¨åˆ°æœŸäº†äº‹ä»¶
- å¤–éƒ¨çš„æ–‡ä»¶å¯ä»¥è¯»å–ã€è¯»å–å‡ºé”™äº‹ä»¶
- socketæœ‰å†…å®¹äº†ã€å…³é—­äº†å‘Šè¯‰äº‹ä»¶

ä»€ä¹ˆæ˜¯Loop

- loopå°±æ˜¯å¾ªç¯
- äº‹ä»¶æœ‰ä¼˜å…ˆçº§çš„æ‰€ä»¥å¤„ç†èµ·æ¥ä¹Ÿæ˜¯åˆ†å…ˆåçš„
- Node.jséœ€è¦é¡ºåºè®ºè¯¢æ¯ç§äº‹ä»¶ï¼Œæ‰€ä»¥å¾€å¾€æ˜¯å¾ªç¯çš„

Event Loop

- æ“ä½œç³»ç»Ÿå¯ä»¥è§¦å‘äº‹ä»¶ï¼Œjså¯ä»¥å¤„ç†äº‹ä»¶
- Event Loopå°±æ˜¯å¯¹äº‹ä»¶å¤„ç†çš„é¡ºåºç®¡ç†

é¡ºåºç¤ºæ„å›¾ç¿»è¯‘ï¼š[https://juejin.im/post/6844903582538399752](https://juejin.im/post/6844903582538399752)

```javascript
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚        timers         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     I/O callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     idle, prepare     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚         poll          â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚        check          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤    close callbacks    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

é‡ç‚¹é˜¶æ®µ

- timersé˜¶æ®µï¼šæ£€æŸ¥è®¡æ—¶å™¨
- pollè½®è¯¢é˜¶æ®µï¼šå½“è½®è¯¢æ²¡äº‹æƒ…å¤„ç†åä¼šåœæ­¢åœ¨pollé˜¶æ®µ
- checkæ£€æŸ¥setlmmediateå›è°ƒ

æ³¨æ„ï¼šå¤§éƒ¨åˆ†äº‹ä»¶åœåœ¨pollï¼Œæ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚éƒ½åœ¨pollé˜¶æ®µ

### Node.js API

è‹±æ–‡æ–‡æ¡£ï¼š[https://nodejs.org/api/](https://nodejs.org/api/)

ä¸­æ–‡æ–‡æ¡£ï¼š[http://nodejs.cn/api/](http://nodejs.cn/api/)

- [assertï¼ˆæ–­è¨€ï¼‰](http://nodejs.cn/api/assert.html#assert_assert)
- [Bufferï¼ˆç¼“å†²å™¨ï¼‰](http://nodejs.cn/api/buffer.html#buffer_buffer)
- [child_processï¼ˆå­è¿›ç¨‹ï¼‰](http://nodejs.cn/api/child_process.html#child_process_child_process)
- [clusterï¼ˆé›†ç¾¤ï¼‰](http://nodejs.cn/api/cluster.html#cluster_cluster)
- [debuggerï¼ˆè°ƒè¯•å™¨ï¼‰](http://nodejs.cn/api/debugger.html#debugger_debugger)
- [eventsï¼ˆäº‹ä»¶è§¦å‘å™¨ï¼‰](http://nodejs.cn/api/events.html#events_events)
- [fsï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰](http://nodejs.cn/api/fs.html#fs_file_system)
- [globalï¼ˆå…¨å±€å˜é‡ï¼‰](http://nodejs.cn/api/globals.html#globals_global_objects)
- [httpï¼ˆHTTPï¼‰](http://nodejs.cn/api/http.html#http_http)
- [pathï¼ˆè·¯å¾„ï¼‰](http://nodejs.cn/api/path.html#path_path)
- [querystringï¼ˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰](http://nodejs.cn/api/querystring.html#querystring_query_string)
- [streamï¼ˆæµï¼‰](http://nodejs.cn/api/stream.html#stream_stream)
- [timerï¼ˆå®šæ—¶å™¨ï¼‰](http://nodejs.cn/api/timers.html#timers_timers)
- [urlï¼ˆURLï¼‰](http://nodejs.cn/api/url.html#url_url)
- [worker_threadsï¼ˆå·¥ä½œçº¿ç¨‹ï¼‰](http://nodejs.cn/api/worker_threads.html#worker_threads_worker_threads)
